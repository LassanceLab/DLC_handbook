  
  
## 4.1 Outline of the Workflow  
  
The general DLC workflow looks as follows:  
  
1. Initiate project  
2. Add videos to `config.yml`  
3. Extract frames  
4. Manually label frames  
5. Train the model  
6. Analyze videos  
7. (Optional) Extract outlier frames  
8. (Optional) Manually label outlier frames  
9. (Optional) Merge datasets  
10. (Optional) Retrain the model  
11. (Optional) Analyze videos  
12. Create labelled videos  
  
## 4.2 Starting a New Analysis  
  
Start `conda` environment and start DLC GUI.  
  
If you are running DLC on a cluster, proceed to [4. DLC Analysis > 4.5 Running DLC on a cluster (LUCIA)](4.%20DLC%20Analysis.md#4.5%20Running%20DLC%20on%20a%20cluster%20(LUCIA)).  
  
> [!note]    
> Use an Anaconda powershell (or any command line tool) as administrator!  
  
  
```shell  
conda activate DEEPLABCUT #Or however the environment is called  
  
python -m deeplabcut  
```  
  
![8cd17079132bdf21fe7c4021bb57dd3e6d494570653fdeb100f1aee1cceb5cbf.png](./assets/img/8/c/d/8cd17079132bdf21fe7c4021bb57dd3e6d494570653fdeb100f1aee1cceb5cbf.png)  
  
Click “New project”  
  
![0afb3202c57e0df871e68c51e777524b2cf4f2efb314a04b3724348f7d7edb9a.png](./assets/img/0/a/f/0afb3202c57e0df871e68c51e777524b2cf4f2efb314a04b3724348f7d7edb9a.png)  
  
Fill all information.  
  
> [!note]    
Number of cameras refers to the amount of cameras filming the same animal, e.g. top and side view.    
Make sure to check “Copy videos to project folder”. We encountered one instance of test videos getting corrupted during the analysis  
  
> [!warning]    
Do NOT include special characters (e.g. ô é ä etc) in the project name or the experimenter name! This WILL cause issues during the analysis. See [XY. Common Errors and Fixes > XY.2.1 Literally Any DLC Error Message](./XY.%20Common%20Errors%20and%20Fixes.md#XY.2.1%20Literally%20Any%20DLC%20Error%20Message)  
  
## 4.3 Labelling Frames  
  
![b944c1950818b83a92633939af456977f22c07eb388c9bcd7922e60ab68decf1.png](./assets/img/b/9/4/b944c1950818b83a92633939af456977f22c07eb388c9bcd7922e60ab68decf1.png)    
![626b565d353959a469a1eee38023c598e86f5f7dc09b7aa1ea206d4e068edca6.png](./assets/img/6/2/6/626b565d353959a469a1eee38023c598e86f5f7dc09b7aa1ea206d4e068edca6.png)    
![24ad70cc3a88f27b2abfbe357b8a584c8c8e50f641e5d927c16ae69f4241c342.png](./assets/img/2/4/a/24ad70cc3a88f27b2abfbe357b8a584c8c8e50f641e5d927c16ae69f4241c342.png)  
  
## 4.4 Training the Model & Analyze Videos  
  
## 4.5 Fix Outliers, Merge New Training Data, & Create New Training Iteration  
  
## 4.6 Running DLC on a Cluster (LUCIA)  
  
> [!note]    
This section is specifically tailored for running DLC on the LUCIA cluster accessed via the University of Liège, but the same principles should apply to other clusters.  
  
> [!warning]    
> You will need to be somewhat familiar and comfortable to navigate via the command line.    
> Not all surrounding concepts are explained in detail, since this is not a guide on using the cluster, but how to run DLC.  
  
You first need to get access to LUCIA. Check [here](https://support.ceci-hpc.be/doc/_contents/QuickStart/ConnectingToTheClusters/index.html) and [here](https://doc.lucia.cenaero.be/connect/ssh/) for more details on how to access the cluster and prerequisites.    
Also, carefully read the welcome email from LUCIA!  
  
### 4.561 Initial Set-up on LUCIA  
  
Install `DeepLabCut` in your directory.  
  
```bash  
module load devel/python/Anaconda3-2022.05  
conda create --name DEEPLABCUT   
conda activate DEEPLABCUT    
pip install deeplabcut    
conda install ffmpeg  
```  
  
> [!note]    
> If you need a pre-release version directly from GitHub for some critical bug fixes, you should create a separate environment and run the following:  
  
 ```bash  
module load devel/python/Anaconda3-2022.05  
conda create --name DLC_dev  
conda activate DLC_dev    
pip install --force-reinstall git+https://github.com/DeepLabCut/DeepLabCut@main    
conda install ffmpeg  
 ```  
  
### 4.6.2 Starting DLC on LUCIA  
  
Confirm that everything is working on the `debug` node.  
  
```bash  
tmux new -s mysession # start tmux with name mysession to keep session active if computer goes to sleep  
srun --account=behavior -p debug-gpu --gpus=1 --time=1:00:00 --pty bash  
module load devel/python/Anaconda3-2022.05  
conda activate DEEPLABCUT  
module load CUDA/11.7.0 TensorFlow/2.11.0-foss-2022a-CUDA-11.7.0  
cd /gpfs/projects/acad/behavior/softs/DeepLabCut/examples/  
python testscript.py  
```  
  
### 4.6.3 Submitting SLURM Scripts  
  
```bash  
sbatch --output=res_DLC_add_extract_cohort1.txt DLC_batch_extract.sh /gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort1/  
  
/gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort2/  
/gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort3/  
/gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort4/  
/gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort5/  
/gpfs/projects/acad/behavior/videos/2023-11-13_conspecific_odor_videos/cohort6/  
```  
  
The logic is `sbatch --output=file_name.txt submission_script.sh /file_path/` for the SLURM script.    
Each SLURM script contains a fallback output file, but to ensure an individual file per job, it should be defined in the call.    
Each SLURM script also contains `python script_name.py $1`, where `$1` refers to the `/file_path/` in the `sbatch` call.    
Each DLC script contains ```  
  
```python  
my_path = sys.argv[1]  
video_file_path = glob.glob(os.path.join(my_path, "*.mp4"))  
```  
  
which will first set `my_path` to `$1` and therefore `/file_path/` from the `sbatch` submission, and as a second step create a list of all `mp4` files inside `my_path` and pass them as a list of strings to `video_file_path`.  
  
See [[XZ. Code directory]] for an overview of all scripts.  
  
> [!warning] Warning    
> Due to a recent bug in DLC (see [issue here](https://github.com/DeepLabCut/DeepLabCut/issues/2482)) this does not work at the moment!    
> All file paths need to be explicitly stated in the script, unfortunately.    
> This warning will be removed once the issue is fixed.  
  
### 4.6.4 DLC Benchmarks on LUCIA  
  
To estimate how long you need to perform certain tasks, here a few benchmarks we have collected from LUCIA.  
  
#### 4.6.4.1 Extracting Frames  
  
Extracting frames with `kmeans` can take quite a while since each video is down-sampled first, frames are extracted, and then an algorithm compares the frames.    
For a 20 minutes video with 200fps, we have gotten the following results (rounded up).  
  
| cluster_step | time per video (min) |  
| ------------:| --------------------:|  
|            1 |                   40 |  
|           10 |                   13 |  
|           20 |                    7 |  
|           50 |                    3 |  
  
Extracting frames with `uniform` is much faster (and doable on a desktop computer) but was not tested on the cluster.  
